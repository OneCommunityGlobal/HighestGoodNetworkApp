#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Check if dependencies are installed
if [ ! -d "node_modules" ]; then
  echo "âš ï¸  Dependencies not installed. Skipping pre-push checks."
  echo "ğŸ’¡ Run 'npm install' to enable pre-push test and lint checks."
  exit 0
fi

echo "ğŸ§ª Running tests before push..."
if [ -f "node_modules/.bin/vitest" ] || command -v vitest >/dev/null 2>&1; then
  npm run test -- --bail=1
  test_status=$?
else
  echo "âš ï¸  vitest not found. Skipping tests."
  echo "ğŸ’¡ Run 'npm install' to install test dependencies."
  test_status=0
fi

echo "ğŸ§¹ Running lint before push..."
if [ -f "node_modules/.bin/eslint" ] || command -v eslint >/dev/null 2>&1; then
  npm run lint
  lint_status=$?
else
  echo "âš ï¸  eslint not found. Skipping lint."
  echo "ğŸ’¡ Run 'npm install' to install lint dependencies."
  lint_status=0
fi

# Block push if either fails
if [ $test_status -ne 0 ] || [ $lint_status -ne 0 ]; then
  echo "âŒ Push blocked: Lint or test failed."
  exit 1
fi

echo "âœ… All checks passed. Proceeding with push..."