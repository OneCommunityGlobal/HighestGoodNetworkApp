#!/bin/sh
# Load nvm if available
export NVM_DIR="$HOME/.nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
# Use Node 20 if available (or install if needed)
if [ -f .nvmrc ]; then
  nvm use 20 2>/dev/null || nvm install 20 && nvm use 20
fi

. "$(dirname "$0")/_/husky.sh"

echo ""
echo "ğŸ›¡ï¸  Husky pre-commit hook triggered"

# Block plain .css files (except .module.css and index.css)
for file in $(git diff --cached --name-only --diff-filter=ACM | grep '\.css$'); do
  case "$file" in
    *index.css) ;;            # allow index.css
    *.module.css) ;;          # allow module.css
    *)
      echo "âŒ  $file is not allowed. Use .module.css instead."
      exit 1
      ;;
  esac
done

echo "ğŸ› ï¸  Attempting to auto-fix lint issues (if possible)..."
echo "ğŸ” Running ESLint via lint-staged on staged files:"
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx|css)$' || echo "No JS/TS/CSS files staged."

# Run lint-staged only if relevant files are staged
if git diff --cached --name-only | grep -qE '\.(js|jsx|ts|tsx|css)$'; then
  npx lint-staged
  lint_exit_code=$?

  if [ $lint_exit_code -eq 0 ]; then
    echo "âœ… Lint passed or was auto-fixed. Proceeding with commit."
  else
    echo "âŒ Lint failed. Some issues couldn't be auto-fixed. Commit aborted."
    echo "ğŸ’¡ Please fix the errors and try again."
    exit $lint_exit_code
  fi
else
  echo "â„¹ï¸  No JS/TS/CSS files to lint. Skipping lint-staged."
fi