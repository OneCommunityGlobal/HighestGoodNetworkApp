version: 2
jobs:

  build_development:
    docker:
      - image: cimg/node:14.17.0
    steps:
      - checkout
      - run:
          name: Set environment variables (Does this do anything given Surge is a CDN?)
          command: export REACT_APP_APIENDPOINT=$APIENDPOINT_BETA SKIP_PREFLIGHT_CHECK=true
      - run:
          name: Install NodeJS dependencies
          command: npm install
      - run:
          name: Build the React client
          command: npm run build
      - run:
          name: Create 200.html for (required for Surge)
          command: cp build/index.html build/200.html
      - run:
          name: Deploy compiled app to surge.sh on $SURGE_DOMAIN_DEV
          command: ./node_modules/.bin/surge --domain $SURGE_DOMAIN_DEV --project ./build

  build_production:
    docker:
      - image: cimg/node:14.17.0
    steps:
      - checkout
      - run:
          name: Set environment variables (Does this do anything given Surge is a CDN?)
          command: export REACT_APP_APIENDPOINT=$APIENDPOINT_PROD REACT_APP_SENTRY_URL=$SENTRY_URL_PROD SKIP_PREFLIGHT_CHECK=true
      - run:
          name: Install NodeJS dependencies
          command: npm install
      - run:
          name: Build the React client
          command: npm run build
      - run:
          name: Create 200.html for (required for Surge)
          command: cp build/index.html build/200.html
      - run:
          name: Deploy compiled app to surge.sh on $SURGE_DOMAIN_PROD
          command: ./node_modules/.bin/surge --domain $SURGE_DOMAIN_PROD --project ./build
      - run:
          name: Deploy compiled app to surge.sh on highestgood.com
          command: ./node_modules/.bin/surge --domain highestgood.com --project ./build
          
workflows:
  version: 2
  build-deploy:

      - build_development:
          filters:
            branches:
              only:
                - development

      - build_production:
          filters:
            branches:
              only:
                - main

